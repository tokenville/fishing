# –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤ –∏ –±–∞–ª–∞–Ω—Å–æ–≤

## üìã –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

–°–∏—Å—Ç–µ–º–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤ –∏ –±–∞–ª–∞–Ω—Å–æ–≤ –±—ã–ª–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –Ω–æ–≤—ã–º–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏.

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
**–ë—ã–ª–æ:**
- 10 BAIT tokens
- 2 —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ —É–¥–æ—á–∫–∏ (Long + Short)
- –ë–∞–ª–∞–Ω—Å $10,000

**–°—Ç–∞–ª–æ:**
- 0 BAIT tokens
- 1 —Å—Ç–∞—Ä—Ç–æ–≤–∞—è —É–¥–æ—á–∫–∞ (Long)
- –ë–∞–ª–∞–Ω—Å $0 (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `user_balances`)

### 2. –ó–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É (–æ–Ω–±–æ—Ä–¥–∏–Ω–≥)
- ‚úÖ +10 BAIT (—Ä–∞–±–æ—Ç–∞–ª–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

### 3. –ó–∞ –ø–µ—Ä–≤—ã–π /cast
**–ë—ã–ª–æ:**
- –ù–µ —Ä–∞–±–æ—Ç–∞–ª–æ (—É–¥–æ—á–∫–∏ —É–∂–µ –¥–∞–≤–∞–ª–∏—Å—å –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)

**–°—Ç–∞–ª–æ:**
- +1 —É–¥–æ—á–∫–∞ Short (—Ç–µ–ø–µ—Ä—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Long + Short)

### 4. –ó–∞ –ø–µ—Ä–≤—ã–π —É–ª–æ–≤ (/hook)
**–ë—ã–ª–æ:**
- +$1000 –≤ –ø–æ–ª–µ `balance_bonus`

**–°—Ç–∞–ª–æ:**
- +$10,000 –∫ –±–∞–ª–∞–Ω—Å—É –≤ —Ç–∞–±–ª–∏—Ü–µ `user_balances` (—Å—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–∞–ø–∏—Ç–∞–ª)

### 5. –°–∏—Å—Ç–µ–º–∞ –±–∞–ª–∞–Ω—Å–∞
**–ë—ã–ª–æ:**
- –ë–∞–ª–∞–Ω—Å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–ª—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏: `10000 + SUM(1000 * pnl_percent / 100) + balance_bonus`

**–°—Ç–∞–ª–æ:**
- –ë–∞–ª–∞–Ω—Å —Ö—Ä–∞–Ω–∏—Ç—Å—è —Å—Ç–∞—Ç–∏—á–Ω–æ –≤ —Ç–∞–±–ª–∏—Ü–µ `user_balances`
- –ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: $0
- –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ /hook –±–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è: `balance += 1000 * pnl_percent / 100`

### 6. –£–¥–∞–ª–µ–Ω—ã —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –ø–æ–ª—è
- `balance_bonus` –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `users` (—Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `user_balances`)
- `inheritance_claimed` –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `users` (—É—Å—Ç–∞—Ä–µ–≤—à–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)

## üìä –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞
```sql
CREATE TABLE user_balances (
    user_id BIGINT PRIMARY KEY REFERENCES users(telegram_id),
    balance NUMERIC(18, 2) DEFAULT 0,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ users
```sql
-- –ë—ã–ª–æ: bait_tokens INTEGER DEFAULT 10
-- –°—Ç–∞–ª–æ: bait_tokens INTEGER DEFAULT 0

-- –£–¥–∞–ª–µ–Ω—ã —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –ø–æ–ª—è:
-- balance_bonus NUMERIC(18, 2) DEFAULT 0  -- —É–¥–∞–ª–µ–Ω–æ
-- inheritance_claimed BOOLEAN DEFAULT FALSE  -- —É–¥–∞–ª–µ–Ω–æ
```

## üîß –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### src/database/db_manager.py
1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `user_balances` –≤ `init_database()`
2. ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ BAIT: 10 ‚Üí 0
3. ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `give_single_starter_rod()` –¥–ª—è –≤—ã–¥–∞—á–∏ –æ–¥–Ω–æ–π —É–¥–æ—á–∫–∏
4. ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∞ `create_user()` - –≤—ã–¥–∞–µ—Ç 0 BAIT, —Å–æ–∑–¥–∞–µ—Ç –±–∞–ª–∞–Ω—Å, –¥–∞–µ—Ç 1 Long —É–¥–æ—á–∫—É
5. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –±–∞–ª–∞–Ω—Å–æ–º:
   - `get_user_balance()` - –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
   - `update_user_balance_after_hook()` - –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ —É–ª–æ–≤–∞
   - `add_balance_bonus()` - –¥–æ–±–∞–≤–∏—Ç—å –±–æ–Ω—É—Å –∫ –±–∞–ª–∞–Ω—Å—É
6. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ `get_user_virtual_balance()` - —á–∏—Ç–∞–µ—Ç –∏–∑ `user_balances`
7. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ `award_first_cast_reward()` - –¥–∞–µ—Ç Short —É–¥–æ—á–∫—É
8. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ `award_first_catch_reward()` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `user_balances`
9. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ `get_flexible_leaderboard()` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `user_balances.balance`
10. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ `migrate_user_balances()` - –º–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### src/bot/commands/hook.py
1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `update_user_balance_after_hook`
2. ‚úÖ –ü–æ—Å–ª–µ `close_position()` –¥–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `update_user_balance_after_hook()`

### src/bot/commands/start.py
1. ‚úÖ –£–±—Ä–∞–Ω `give_starter_rod()` –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. ‚úÖ –£–±—Ä–∞–Ω –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∏–º–ø–æ—Ä—Ç `give_starter_rod`

## üöÄ –ú–∏–≥—Ä–∞—Ü–∏—è

–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `migrate_balances.py` –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

```bash
python3 migrate_balances.py
```

–°–∫—Ä–∏–ø—Ç:
1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (—Å–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É `user_balances`)
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å –ø–æ —Å—Ç–∞—Ä–æ–π —Ñ–æ—Ä–º—É–ª–µ
3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –±–∞–ª–∞–Ω—Å –≤ —Ç–∞–±–ª–∏—Ü—É `user_balances`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ (0 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ - –±–∞–∑–∞ –ø—É—Å—Ç–∞—è)

## üìù –ò—Ç–æ–≥–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è** ‚Üí 0 BAIT, 1 Long —É–¥–æ—á–∫–∞, $0 –±–∞–ª–∞–Ω—Å
2. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É** ‚Üí +10 BAIT
3. **–ü–µ—Ä–≤—ã–π /cast** ‚Üí +1 Short —É–¥–æ—á–∫–∞ (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π cast)
4. **–ü–µ—Ä–≤—ã–π /hook** ‚Üí +$10,000 –∫ –±–∞–ª–∞–Ω—Å—É (—Å—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–∞–ø–∏—Ç–∞–ª)
5. **–ö–∞–∂–¥—ã–π –ø–æ—Å–ª–µ–¥—É—é—â–∏–π /hook** ‚Üí –±–∞–ª–∞–Ω—Å –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ PnL: `delta = $1000 * pnl% / 100`

## üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:
1. ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (0 BAIT, 1 —É–¥–æ—á–∫–∞)
2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É (+10 BAIT)
3. ‚úÖ –ü–µ—Ä–≤—ã–π cast (–ø–æ–ª—É—á–µ–Ω–∏–µ Short —É–¥–æ—á–∫–∏)
4. ‚úÖ –ü–µ—Ä–≤—ã–π hook (+$1000)
5. ‚úÖ –í—Ç–æ—Ä–æ–π hook (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ PnL)
6. ‚úÖ Leaderboard (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤)

## üì¶ –§–∞–π–ª—ã —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

- `src/database/db_manager.py` - –æ—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- `src/bot/commands/hook.py` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ—Å–ª–µ hook
- `src/bot/commands/start.py` - —É–±—Ä–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã–¥–∞—á–∞ —É–¥–æ—á–µ–∫
- `migrate_balances.py` - —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
- `BALANCE_MIGRATION_NOTES.md` - —ç—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
